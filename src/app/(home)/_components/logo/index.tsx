"use client";

import React, { useRef, useState, useEffect } from "react";

import { createWaterSplash } from "./effects/waterEffect";
import { createLeaf } from "./effects/leafEffect";
import { useLogoAnimation } from "./useLogoAnimation";

export const Logo: React.FC<React.SVGProps<SVGSVGElement>> = () => {
  const logoRef = useRef<SVGSVGElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [isAnimationComplete, setIsAnimationComplete] = useState(false);
  const [particles, setParticles] = useState<HTMLDivElement[]>([]);
  const [leaves] = useState<HTMLDivElement[]>([]);

  // Tạo các particle cho hiệu ứng
  useEffect(() => {
    if (!containerRef.current) return;

    const newParticles: HTMLDivElement[] = [];
    for (let i = 0; i < 40; i++) {
      const particle = document.createElement("div");
      particle.className = "signature-particle";
      particle.style.position = "absolute";
      particle.style.width = `${Math.random() * 6 + 2}px`;
      particle.style.height = `${Math.random() * 6 + 2}px`;
      particle.style.backgroundColor = `rgba(101, 163, 13, ${Math.random() * 0.8 + 0.2})`;
      particle.style.borderRadius = "50%";
      particle.style.pointerEvents = "none";
      particle.style.opacity = "0";
      containerRef.current.appendChild(particle);
      newParticles.push(particle);
    }

    setParticles(newParticles);

    return () => {
      newParticles.forEach((p) => {
        containerRef.current?.removeChild(p);
      });
    };
  }, []);

  // Tạo các lá rơi sau khi animation hoàn thành
  useEffect(() => {
    if (!isAnimationComplete || !containerRef.current) return;

    const newLeaves: HTMLDivElement[] = [];

    // Tạo hiệu ứng lá rơi liên tục
    const leafInterval = setInterval(() => {
      if (newLeaves.length >= 15) {
        // Giảm số lượng lá tối đa
        // Giới hạn số lượng lá
        const oldestLeaf = newLeaves.shift();
        if (oldestLeaf && containerRef.current) {
          containerRef.current.removeChild(oldestLeaf);
        }
      }

      // Tạo lá với tỉ lệ thấp hơn
      if (Math.random() < 0.7) {
        // 70% cơ hội tạo lá mỗi interval
        // Tạo ít lá hơn mỗi lần
        const leafCount = Math.random() < 0.7 ? 1 : 2; // 70% tạo 1 lá, 30% tạo 2 lá
        for (let i = 0; i < leafCount; i++) {
          if (containerRef.current) {
            createLeaf(containerRef.current, newLeaves, createWaterSplash);
          }
        }
      }
    }, 1200); // Khoảng cách lâu hơn giữa các lần tạo lá

    return () => {
      clearInterval(leafInterval);
      newLeaves.forEach((leaf) => {
        if (containerRef.current) containerRef.current.removeChild(leaf);
      });
    };
  }, [isAnimationComplete]);

  // Sử dụng custom hook để animation
  useLogoAnimation(
    logoRef as React.RefObject<SVGSVGElement>,
    containerRef as React.RefObject<HTMLDivElement>,
    particles,
    setIsAnimationComplete,
    leaves,
    createLeaf,
    createWaterSplash,
  );

  // Hiệu ứng click - tạo hiệu ứng rơi lá thêm nhưng vừa phải
  const handleClick = () => {
    if (!isAnimationComplete || !containerRef.current) return;

    // Giới hạn số lượng phần tử mỗi lần click
    const maxElements = 6; // Giảm từ 10 xuống 6

    // Tạo một loạt lá rơi khi click - số lượng vừa phải
    for (let i = 0; i < maxElements; i++) {
      setTimeout(() => {
        createLeaf(containerRef.current!, leaves, createWaterSplash);
      }, i * 150); // Khoảng cách lâu hơn để không xuất hiện cùng lúc
    }
  };

  return (
    <div
      ref={containerRef}
      style={{
        position: "relative",
        perspective: "1000px",
        transformStyle: "preserve-3d",
        overflow: "visible",
        width: "673px",
        height: "251px",
      }}
    >
      <svg
        ref={logoRef}
        width="673"
        height="251"
        viewBox="0 0 673 251"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        onClick={handleClick}
        style={{
          cursor: "pointer",
          transformStyle: "preserve-3d",
          transform: "translateZ(0)",
          transition: "filter 0.3s ease",
          position: "relative", // Đảm bảo logo ở dưới lá
          zIndex: "10", // Z-index thấp hơn lá
        }}
      >
        <g id="logo-path">
          <path
            d="M322.408 250.463C313.658 250.463 305.971 248.546 299.346 244.713C292.762 240.838 287.617 235.338 283.908 228.213C280.242 221.046 278.408 212.567 278.408 202.775C278.408 192.692 280.325 184.088 284.158 176.963C288.033 169.796 293.262 164.317 299.846 160.525C306.429 156.734 313.825 154.838 322.033 154.838C327.283 154.838 332.179 155.609 336.721 157.15C341.262 158.65 345.304 160.817 348.846 163.65C352.387 166.442 355.262 169.755 357.471 173.588C359.721 177.38 361.158 181.588 361.783 186.213H341.846C341.221 184.005 340.325 182.046 339.158 180.338C338.033 178.588 336.637 177.13 334.971 175.963C333.304 174.755 331.408 173.838 329.283 173.213C327.2 172.546 324.887 172.213 322.346 172.213C317.596 172.213 313.408 173.4 309.783 175.775C306.2 178.109 303.387 181.546 301.346 186.088C299.346 190.63 298.346 196.13 298.346 202.588C298.346 209.046 299.346 214.546 301.346 219.088C303.346 223.63 306.137 227.109 309.721 229.525C313.346 231.9 317.617 233.088 322.533 233.088C326.992 233.088 330.783 232.296 333.908 230.713C337.075 229.088 339.492 226.817 341.158 223.9C342.867 220.984 343.721 217.546 343.721 213.588L347.721 214.213H323.783V199.4H362.721V211.15C362.721 219.317 360.992 226.338 357.533 232.213C354.075 238.088 349.304 242.609 343.221 245.775C337.179 248.9 330.242 250.463 322.408 250.463Z"
            fill="#3C6300"
          />
          <path
            d="M268.096 156.088V249.213H251.096L210.658 190.65H209.846V249.213H190.221V156.088H207.471L247.658 214.65H248.471V156.088H268.096Z"
            fill="#3C6300"
          />
          <path
            d="M136.283 250.463C128.033 250.463 120.617 248.588 114.033 244.838C107.45 241.088 102.242 235.65 98.4082 228.525C94.5749 221.4 92.6582 212.796 92.6582 202.713C92.6582 192.546 94.5749 183.9 98.4082 176.775C102.242 169.609 107.45 164.171 114.033 160.463C120.617 156.713 128.033 154.838 136.283 154.838C144.533 154.838 151.95 156.713 158.533 160.463C165.117 164.171 170.304 169.609 174.096 176.775C177.929 183.9 179.846 192.546 179.846 202.713C179.846 212.838 177.929 221.463 174.096 228.588C170.304 235.713 165.117 241.15 158.533 244.9C151.95 248.609 144.533 250.463 136.283 250.463ZM136.283 233.088C141.075 233.088 145.242 231.921 148.783 229.588C152.325 227.255 155.054 223.838 156.971 219.338C158.929 214.796 159.908 209.255 159.908 202.713C159.908 196.13 158.929 190.567 156.971 186.025C155.054 181.484 152.325 178.046 148.783 175.713C145.242 173.38 141.075 172.213 136.283 172.213C131.533 172.213 127.387 173.38 123.846 175.713C120.304 178.046 117.533 181.484 115.533 186.025C113.575 190.567 112.596 196.13 112.596 202.713C112.596 209.255 113.575 214.796 115.533 219.338C117.533 223.838 120.304 227.255 123.846 229.588C127.387 231.921 131.533 233.088 136.283 233.088Z"
            fill="#3C6300"
          />
          <path
            d="M38.4707 249.213H14.2207V232.338H37.5957C43.4707 232.338 48.3874 231.317 52.3457 229.275C56.3457 227.192 59.3457 223.963 61.3457 219.588C63.3874 215.171 64.4082 209.505 64.4082 202.588C64.4082 195.713 63.3874 190.088 61.3457 185.713C59.3457 181.338 56.3457 178.13 52.3457 176.088C48.3874 174.005 43.4915 172.963 37.6582 172.963H13.8457V156.088H38.7832C48.1582 156.088 56.2207 157.963 62.9707 161.713C69.7207 165.421 74.9082 170.755 78.5332 177.713C82.1582 184.63 83.9707 192.921 83.9707 202.588C83.9707 212.296 82.1374 220.63 78.4707 227.588C74.8457 234.546 69.6374 239.9 62.8457 243.65C56.054 247.359 47.929 249.213 38.4707 249.213ZM25.0957 156.088V249.213H5.4707V156.088H25.0957Z"
            fill="#3C6300"
          />
          <path
            d="M632.658 96.4629C623.908 96.4629 616.221 94.5462 609.596 90.7129C603.012 86.8379 597.867 81.3379 594.158 74.2129C590.492 67.0462 588.658 58.5671 588.658 48.7754C588.658 38.6921 590.575 30.0879 594.408 22.9629C598.283 15.7962 603.512 10.3171 610.096 6.52539C616.679 2.73372 624.075 0.837891 632.283 0.837891C637.533 0.837891 642.429 1.60872 646.971 3.15039C651.512 4.65039 655.554 6.81706 659.096 9.65039C662.637 12.4421 665.512 15.7546 667.721 19.5879C669.971 23.3796 671.408 27.5879 672.033 32.2129H652.096C651.471 30.0046 650.575 28.0462 649.408 26.3379C648.283 24.5879 646.887 23.1296 645.221 21.9629C643.554 20.7546 641.658 19.8379 639.533 19.2129C637.45 18.5462 635.137 18.2129 632.596 18.2129C627.846 18.2129 623.658 19.4004 620.033 21.7754C616.45 24.1087 613.637 27.5462 611.596 32.0879C609.596 36.6296 608.596 42.1296 608.596 48.5879C608.596 55.0462 609.596 60.5462 611.596 65.0879C613.596 69.6296 616.387 73.1087 619.971 75.5254C623.596 77.9004 627.867 79.0879 632.783 79.0879C637.242 79.0879 641.033 78.2962 644.158 76.7129C647.325 75.0879 649.742 72.8171 651.408 69.9004C653.117 66.9837 653.971 63.5462 653.971 59.5879L657.971 60.2129H634.033V45.4004H672.971V57.1504C672.971 65.3171 671.242 72.3379 667.783 78.2129C664.325 84.0879 659.554 88.6087 653.471 91.7754C647.429 94.9004 640.492 96.4629 632.658 96.4629Z"
            fill="#3C6300"
          />
          <path
            d="M578.346 2.08789V95.2129H561.346L520.908 36.6504H520.096V95.2129H500.471V2.08789H517.721L557.908 60.6504H558.721V2.08789H578.346Z"
            fill="#3C6300"
          />
          <path
            d="M446.533 96.4629C438.283 96.4629 430.867 94.5879 424.283 90.8379C417.7 87.0879 412.492 81.6504 408.658 74.5254C404.825 67.4004 402.908 58.7962 402.908 48.7129C402.908 38.5462 404.825 29.9004 408.658 22.7754C412.492 15.6087 417.7 10.1712 424.283 6.46289C430.867 2.71289 438.283 0.837891 446.533 0.837891C454.783 0.837891 462.2 2.71289 468.783 6.46289C475.367 10.1712 480.554 15.6087 484.346 22.7754C488.179 29.9004 490.096 38.5462 490.096 48.7129C490.096 58.8379 488.179 67.4629 484.346 74.5879C480.554 81.7129 475.367 87.1504 468.783 90.9004C462.2 94.6087 454.783 96.4629 446.533 96.4629ZM446.533 79.0879C451.325 79.0879 455.492 77.9212 459.033 75.5879C462.575 73.2546 465.304 69.8379 467.221 65.3379C469.179 60.7962 470.158 55.2546 470.158 48.7129C470.158 42.1296 469.179 36.5671 467.221 32.0254C465.304 27.4837 462.575 24.0462 459.033 21.7129C455.492 19.3796 451.325 18.2129 446.533 18.2129C441.783 18.2129 437.637 19.3796 434.096 21.7129C430.554 24.0462 427.783 27.4837 425.783 32.0254C423.825 36.5671 422.846 42.1296 422.846 48.7129C422.846 55.2546 423.825 60.7962 425.783 65.3379C427.783 69.8379 430.554 73.2546 434.096 75.5879C437.637 77.9212 441.783 79.0879 446.533 79.0879Z"
            fill="#3C6300"
          />
          <path
            d="M372.846 2.08789H392.533V62.5254C392.533 69.3171 390.908 75.2754 387.658 80.4004C384.45 85.4837 379.95 89.4421 374.158 92.2754C368.367 95.1087 361.617 96.5254 353.908 96.5254C346.2 96.5254 339.45 95.1087 333.658 92.2754C327.867 89.4421 323.367 85.4837 320.158 80.4004C316.95 75.2754 315.346 69.3171 315.346 62.5254V2.08789H334.971V60.9004C334.971 64.4421 335.762 67.6087 337.346 70.4004C338.929 73.1504 341.137 75.3171 343.971 76.9004C346.804 78.4421 350.117 79.2129 353.908 79.2129C357.742 79.2129 361.075 78.4421 363.908 76.9004C366.742 75.3171 368.929 73.1504 370.471 70.4004C372.054 67.6087 372.846 64.4421 372.846 60.9004V2.08789Z"
            fill="#3C6300"
          />
          <path
            d="M235.471 95.2129V2.08789H272.158C279.2 2.08789 285.2 3.33789 290.158 5.83789C295.158 8.33789 298.971 11.8796 301.596 16.4629C304.262 21.0046 305.596 26.3587 305.596 32.5254C305.596 38.6921 304.262 44.0046 301.596 48.4629C298.929 52.9212 295.054 56.3379 289.971 58.7129C284.929 61.0462 278.825 62.2129 271.658 62.2129H247.096V46.4004H268.471C272.262 46.4004 275.387 45.8796 277.846 44.8379C280.346 43.7962 282.2 42.2546 283.408 40.2129C284.658 38.1712 285.283 35.6087 285.283 32.5254C285.283 29.4004 284.658 26.7962 283.408 24.7129C282.2 22.5879 280.346 20.9837 277.846 19.9004C275.346 18.7754 272.2 18.2129 268.408 18.2129H255.096V95.2129H235.471ZM287.158 95.2129L264.471 52.8379H285.721L308.908 95.2129H287.158Z"
            fill="#3C6300"
          />
          <path
            d="M150.533 18.3379V2.08789H227.033V18.3379H198.533V95.2129H179.096V18.3379H150.533Z"
            fill="#3C6300"
          />
          <path
            d="M116.596 2.08789V95.2129H96.9707V2.08789H116.596Z"
            fill="#3C6300"
          />
          <path
            d="M22.3457 2.08789L44.7832 72.8379H45.6582L68.2207 2.08789H89.9707L57.9082 95.2129H32.5332L0.408203 2.08789H22.3457Z"
            fill="#3C6300"
          />
        </g>
      </svg>
    </div>
  );
};

export default Logo;
